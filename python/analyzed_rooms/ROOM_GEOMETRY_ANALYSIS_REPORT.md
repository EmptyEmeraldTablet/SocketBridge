# 房间几何分析报告

## 概述

基于93个采样点数据，对43个房间进行了几何分析。通过**时间戳匹配**将采样点分配到对应房间，并分析坐标规律。

---

## 房间类型与坐标规律

### 1. 标准矩形房间 (Shape 1)

**边界特征**: `(60, 140) - (580, 420)`
- **宽度**: 520 像素 (13格)
- **高度**: 280 像素 (7格)

**采样点分布规律**:
- 玩家位置 x 范围: ~70-570 (左右墙内缩约15像素)
- 玩家位置 y 范围: ~150-410 (上下墙内缩约10-15像素)
- 四面墙都应该有采样点

**示例房间**:
| 房间 | Stage | Type | 采样数 | 推断尺寸 | 边界匹配 |
|------|-------|------|--------|---------|----------|
| 83 | 1 | 6 | 7 | 490x250 | ✅ |
| 107 | 6 | 1 | 29 | 850x530 | ❌ |
| 121 | 3 | 5 | 7 | 520x250 | ⚠️ 数据异常 |

---

### 2. 宽房间 (Shape 6)

**边界特征**: `(60, 140) - (1100, 420)`
- **宽度**: 1040 像素 (26格)
- **高度**: 280 像素 (7格)
- **宽高比**: 3.7:1

**采样点分布规律**:
- 玩家位置 x 范围: ~70-1085 (左右墙内缩)
- 玩家位置 y 范围: ~150-410 (上下墙内缩)
- 左右墙距离远，需要更多水平移动

**示例房间**:
| 房间 | Stage | Type | 采样数 | 推断尺寸 | 边界匹配 |
|------|-------|------|--------|---------|----------|
| 58 | 1 | 1 | 9 | 1010x250 | ✅ |

---

### 3. 高房间 (Shape 4)

**边界特征**: `(60, 140) - (580, 700)`
- **宽度**: 520 像素 (13格)
- **高度**: 560 像素 (14格)
- **宽高比**: 1:1.07

**采样点分布规律**:
- 玩家位置 x 范围: ~70-570
- 玩家位置 y 范围: ~150-685 (上下墙内缩)
- 上下墙距离远，需要更多垂直移动

**示例房间**:
| 房间 | Stage | Type | 采样数 | 推断尺寸 | 边界匹配 |
|------|-------|------|--------|---------|----------|
| 48 | 4 | 1 | 6 | 490x530 | ✅ |

---

### 4. L形房间 (Shape 2) - ✅ 确认

**边界特征**: `(60, 220) - (580, 340)`
- **宽度**: 520 像素 (13格)
- **高度**: 120 像素 (3格)
- **宽高比**: 4.3:1 (异常)

**关键特征**:
- 房间高度只有标准房间的43% (120/280)
- 玩家只能访问房间下半部分
- 顶部区域被天花板完全遮挡

**Room 73 详细分析**:

```
游戏报告边界: (60, 220) - (580, 340)
推断边界:     (75, 220) - (565, 325)
推断尺寸:     490 x 105

采样点位置:
  [1] (   70.0,   230.6) -> left wall
  [2] (   70.0,   230.6) -> left wall
  [3] (   70.0,   330.0) -> bottom wall
  [4] (  570.0,   330.0) -> right wall
  [5] (  570.0,   230.5) -> right wall
  [6] (  570.0,   230.5) -> right wall

y坐标分布: 230-330 (顶部 220-230 完全没有采样)
结论: 房间顶部被遮挡，玩家只能访问下半部分
```

**结论**: Room 73 是**真正的L形房间**，折角在**顶部**。

---

### 5. 商店房间 (Shape 3)

**边界特征**: `(220, 140) - (420, 420)`
- **宽度**: 200 像素 (5格)
- **高度**: 280 像素 (7格)
- **宽高比**: 0.71:1

**Room 45 详细分析**:

```
游戏报告边界: (220, 140) - (420, 420)
推断边界:     (235, 155) - (420, 405)
推断尺寸:     185 x 250

采样点位置:
  [1] (  409.5,   150.3) -> top wall (靠近右上角)
  [2] (  409.5,   410.0) -> bottom wall (靠近右下角)
  [3] (  409.5,   410.0) -> bottom wall
  [4] (  230.0,   410.0) -> bottom-left corner
  [5] (  230.0,   150.4) -> top-left corner

墙壁采样分布: left=2, right=0, top=1, bottom=2
结论: 右侧无采样不代表房间缺失右侧，而是玩家没有飞到右侧
      这是一个小矩形房间，不是L形
```

**结论**: Room 45 是**小矩形房间**，不是L形。

---

## 边界一致性分析

### 推断边界与游戏边界对比

| 房间 | 游戏边界 | 推断边界 | 最大差异 | 状态 |
|------|---------|---------|---------|------|
| 18 | (60,140)-(580,700) | (75,155)-(565,405) | 295 | ❌ |
| 34 | (60,140)-(580,420) | (75,155)-(1085,685) | 505 | ❌ |
| 45 | (220,140)-(420,420) | (235,155)-(420,405) | 15 | ✅ |
| 48 | (60,140)-(580,700) | (75,155)-(565,685) | 15 | ✅ |
| 58 | (60,140)-(1100,420) | (75,155)-(1085,405) | 15 | ✅ |
| 73 | (60,220)-(580,340) | (75,220)-(565,325) | 15 | ✅ |
| 83 | (60,140)-(580,420) | (75,155)-(565,405) | 15 | ✅ |
| 107 | (60,140)-(580,420) | (235,155)-(1085,685) | 505 | ❌ |
| 121 | (60,140)-(580,420) | (60,155)-(1090,405) | 510 | ❌ |

### 差异分析

**差异大的房间 (❌)**:

1. **Room 18**: 游戏报告是高房间(580,700)，但采样只覆盖下半部分(405)
   - 原因: 玩家只访问了房间下半部分（可能还在清理敌人）

2. **Room 34**: 游戏报告是标准房间(580,420)，但采样覆盖了更大范围
   - 原因: Room 34的采样时间与Room 72/73重叠，采样边界是L形房间的边界
   - 采样数据中 room_top_left/bottom_right 不准确

3. **Room 107**: 游戏报告是标准房间(580,420)，但采样覆盖了整个大区域
   - 原因: 玩家在房间内移动距离远，可能跨越了多个房间区域

4. **Room 121**: 游戏报告是标准房间(580,420)，但采样显示边界是(1100)
   - 原因: **数据记录问题** - 采样时记录的是Room 72的边界(宽房间)
   - 采样点 x=1089.5 明显在宽房间内

**匹配良好的房间 (✅)**:
- 45, 48, 58, 73, 83: 推断边界与游戏边界接近（差异<20像素）

---

## 房间形状代码对照

| Shape Code | 房间类型 | 实际形状 | 说明 |
|------------|---------|---------|------|
| 0 | - | rectangle | 未使用 |
| 1 | 普通房间 | rectangle | 标准矩形 |
| 2 | 普通房间 | L_shape | L形房间（顶部折角） |
| 3 | 商店 | rectangle | 小矩形，非L形 |
| 4 | 挑战房间 | rectangle | 高房间 |
| 5 | - | - | 未确认 |
| 6 | 宽房间 | rectangle | 宽房间 |
| 7 | - | - | 未使用 |
| 8 | Boss房间 | rectangle | 超大房间 |

---

## 关键发现

### 1. 只有 Room 73 是真正的 L 形房间

- **特征**: Shape Code = 2，边界高度120像素（标准280像素）
- **折角方向**: 顶部
- **原因**: 房间顶部被天花板遮挡，玩家只能访问下半部分

### 2. Shape Code 3 不一定是 L 形

- Room 45 (Shape 3, 商店) 是小矩形房间
- 玩家没有飞到右侧墙壁，不代表房间缺失右侧

### 3. 采样边界信息不可信

- 多个房间共享相同的 room_top_left/bottom_right
- Room 72 和 Room 73 使用完全相同的边界 (60,220)-(580,340)
- Room 121 的采样记录的边界是 Room 72 的边界

### 4. 时间戳匹配是可靠的

- 通过 `first_visited_at` 和 `recorded_at` 匹配采样点到房间
- 可以正确区分共享边界的不同房间

---

## 建议

### 采样优化

1. **L形房间**: 需要在房间上方也进行采样，确认折角位置
2. **商店房间**: 需要采样四面墙壁，避免误判
3. **大房间**: 需要更多采样点覆盖完整区域

### 数据记录优化

1. 记录采样时的房间索引 (room_index)，而不仅仅是边界坐标
2. 区分"当前房间"和"上一房间"的边界信息
3. 在切换房间时立即保存采样点数据

---

## 附录: 采样数据统计

| 房间 | Stage | Type | Shape | 采样数 | 形状 | 置信度 |
|------|-------|------|-------|--------|------|--------|
| 18 | 4 | 5 | 4 | 15 | rectangle | 高 |
| 34 | 4 | 1 | 1 | 9 | rectangle | 低 |
| 45 | 2 | 10 | 3 | 5 | rectangle | 低 |
| 48 | 4 | 1 | 4 | 6 | rectangle | 中 |
| 58 | 1 | 1 | 6 | 9 | rectangle | 高 |
| 73 | 4 | 1 | 2 | 6 | **L_shape** | **高** |
| 83 | 1 | 6 | 1 | 7 | rectangle | 中 |
| 107 | 6 | 1 | 1 | 29 | rectangle | 低 |
| 121 | 3 | 5 | 1 | 7 | rectangle | 低 |

---

*生成时间: 2026-01-13*
*分析工具: room_geometry_analyzer.py v2.0*
